<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{
        layout/mypage-layout :: layout(
          ~{::title},
          ~{::content},
          ~{::css},
          ~{::script}
        )
      }">

<head>
    <title th:fragment="title">ë§ˆì´í˜ì´ì§€ ë©”ì¸</title>

    <th:block th:fragment="css">
        <link rel="stylesheet" th:href="@{/css/mypage.css}">
        <link rel="stylesheet" th:href="@{/css/mypage-navbar.css}">
    </th:block>

    <th:block th:fragment="script">
        <script th:inline="javascript">
            /*<![CDATA[*/
            (function() {
                const calendarData = /*[[${dashboard.calendarSummary}]]*/ null;
                const calendarEl = document.getElementById('dashboard-calendar');
                
                if (calendarData && calendarEl) {
                    renderCalendar(calendarData);
                }
                
                function renderCalendar(data) {
                    const year = data.year;
                    const month = data.month;
                    const days = data.days || [];
                    
                    // ë‚ ì§œë³„ ë°ì´í„°ë¥¼ ë§µìœ¼ë¡œ ë³€í™˜
                    const dayMap = new Map();
                    days.forEach(day => {
                        dayMap.set(day.day, day);
                    });
                    
                    // ì²« ë²ˆì§¸ ë‚ ì§œë¡œ Date ê°ì²´ ìƒì„±
                    const firstDay = new Date(year, month - 1, 1);
                    const lastDay = new Date(year, month, 0);
                    const daysInMonth = lastDay.getDate();
                    const startDayOfWeek = firstDay.getDay(); // 0=ì¼ìš”ì¼, 1=ì›”ìš”ì¼...
                    
                    // ìš”ì¼ í—¤ë”
                    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                    
                    let html = '<div class="calendar-header">';
                    dayNames.forEach(name => {
                        html += `<div class="calendar-day-header">${name}</div>`;
                    });
                    html += '</div>';
                    
                    html += '<div class="calendar-grid">';
                    
                    // ë¹ˆ ì¹¸ ì¶”ê°€ (ì²« ì£¼ ì‹œì‘ ì „)
                    for (let i = 0; i < startDayOfWeek; i++) {
                        html += '<div class="calendar-day empty"></div>';
                    }
                    
                    // ë‚ ì§œ ì¹¸ ì¶”ê°€
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayData = dayMap.get(day);
                        const hasStudy = dayData && dayData.hasStudy;
                        const hasAttendance = dayData && dayData.hasAttendance;
                        const lectureCount = dayData ? dayData.lectureCount : 0;
                        const studyMinutes = dayData ? dayData.studyMinutes : 0;
                        
                        let dayClass = 'calendar-day';
                        if (hasStudy) dayClass += ' has-study';
                        if (hasAttendance) dayClass += ' has-attendance';
                        
                        let statsHtml = '';
                        if (lectureCount > 0 || studyMinutes > 0) {
                            statsHtml = `<div class="calendar-day-stats">`;
                            if (lectureCount > 0) statsHtml += `${lectureCount}ê°•`;
                            if (studyMinutes > 0) statsHtml += ` ${studyMinutes}ë¶„`;
                            statsHtml += `</div>`;
                        }
                        
                        html += `
                            <div class="${dayClass}" data-day="${day}">
                                <div class="calendar-day-number">${day}</div>
                                ${statsHtml}
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    
                    calendarEl.innerHTML = html;
                }
            })();
            /*]]>*/
        </script>
    </th:block>
</head>

<body>

<div th:fragment="content">

    <h1 class="dashboard-title">ëŒ€ì‹œë³´ë“œ</h1>

    <div class="mypage-dashboard">
        <!-- ìµœê·¼ í•™ìŠµ ê°•ì˜ -->
        <section class="card card-large recent-course-card">
            <div class="card-header">
                <h2>ìµœê·¼ í•™ìŠµ ê°•ì˜</h2>
                <a th:href="@{/mypage/courses}" class="view-all-link">í•™ìŠµ ëª©ë¡ ></a>
            </div>
            <div class="recent-course-content" th:if="${dashboard.recentCourse}">
                <div class="course-icon">
                    <div class="play-icon">â–¶</div>
                </div>
                <div class="course-info">
                    <h3 class="course-title" th:text="${dashboard.recentCourse.title}">ì‹œì‘í•˜ëŠ” PMë“¤ì„ ìœ„í•œ í•„ìˆ˜ì§€ì‹</h3>
                    <div class="course-progress">
                        <span class="progress-text" 
                              th:text="${dashboard.recentCourse.currentLecture} + 'ê°• / ' + ${dashboard.recentCourse.totalLectures} + 'ê°• (' + ${#numbers.formatDecimal(dashboard.recentCourse.progressRate, 1, 2)} + '%)'">
                            3ê°• / 29ê°• (10.34%)
                        </span>
                    </div>
                </div>
            </div>
            <div class="recent-course-content" th:unless="${dashboard.recentCourse}">
                <p class="empty-message">í•™ìŠµ ì¤‘ì¸ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </section>

        <!-- ì£¼ê°„ í•™ìŠµ -->
        <section class="card card-small weekly-learning-card">
            <div class="card-header">
                <h2>ì£¼ê°„ í•™ìŠµ</h2>
                <button class="icon-btn" title="ì•Œë¦¼ ì„¤ì •">
                    <span class="gear-icon">âš™</span>
                </button>
            </div>
            <div class="weekly-content" th:if="${dashboard.weeklyLearning}">
                <div class="week-navigation">
                    <button class="nav-btn prev-week">â€¹</button>
                    <div class="week-label" th:text="${dashboard.weeklyLearning.weekLabel}">25ë…„ 12ì›” 3ì£¼ì°¨</div>
                    <button class="nav-btn next-week">â€º</button>
                </div>
                <div class="weekly-calendar">
                    <div class="day-item" th:each="daily, iterStat : ${dashboard.weeklyLearning.dailyLearnings}">
                        <div class="day-name" th:text="${daily.dayOfWeek}">ì›”</div>
                        <div class="day-circle" 
                             th:classappend="${daily.hasStudy} ? 'has-study' : ''"
                             th:attr="data-day=${daily.day}">
                        </div>
                    </div>
                </div>
                <div class="weekly-stats">
                    <div class="stat-item">
                        <span class="stat-icon">â–¶</span>
                        <span class="stat-value" th:text="${dashboard.weeklyLearning.totalLectures}">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">ğŸ•</span>
                        <span class="stat-value" th:text="${dashboard.weeklyLearning.totalMinutes} + 'ë¶„'">0ë¶„</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">ğŸ“„</span>
                        <span class="stat-value" th:text="${dashboard.weeklyLearning.totalNotes}">0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ìˆ˜ë£Œì¦ -->
        <section class="card card-small certificate-card">
            <div class="card-header">
                <h2>ìˆ˜ë£Œì¦</h2>
                <a th:href="@{/mypage/certificates}" class="view-all-link">ì „ì²´ ë³´ê¸° ></a>
            </div>
            <div class="certificate-content" th:if="${dashboard.latestCertificate}">
                <div class="certificate-item">
                    <div class="certificate-icon">ğŸ“œ</div>
                    <div class="certificate-info">
                        <div class="certificate-title" th:text="${dashboard.latestCertificate.courseTitle}">ì´ˆë³´ìë¥¼ ìœ„í•œ íŒŒì›Œí¬ì¸íŠ¸</div>
                        <div class="certificate-date" th:text="${#temporals.format(dashboard.latestCertificate.issuedDate, 'yyyy. MM. dd.')}">2024. 07. 30.</div>
                    </div>
                </div>
            </div>
            <div class="certificate-content" th:unless="${dashboard.latestCertificate}">
                <p class="empty-message">ìˆ˜ë£Œì¦ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </section>

        <!-- ìº˜ë¦°ë” -->
        <section class="card card-large calendar-card">
            <h2>ìº˜ë¦°ë”</h2>
            <div id="dashboard-calendar" th:attr="data-year=${dashboard.calendarSummary.year}, data-month=${dashboard.calendarSummary.month}">
                <!-- ìº˜ë¦°ë”ëŠ” JavaScriptë¡œ ë Œë”ë§ -->
            </div>
        </section>
    </div>

</div>

</body>
</html>