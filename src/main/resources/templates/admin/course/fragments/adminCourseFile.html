<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="courseFile" class="form-section" id="section-file">
    <div class="curriculum-header">
        <h3>커리큘럼 구성</h3>
        <p class="help-text">섹션과 챕터를 추가하여 강의 커리큘럼을 구성하세요.</p>
    </div>

    <!-- 섹션 리스트 컨테이너 -->
    <div id="section-list-container">
        <!-- JS로 섹션 아이템들이 여기에 추가됨 -->
        <!-- 수정 모드일 때 기존 데이터 렌더링 -->
        <th:block th:if="${course != null and course.sections != null}">
            <div class="section-item" th:each="section, sStat : ${course.sections}">
                <div class="section-header">
                    <input type="text" th:name="|sections[${sStat.index}].title|" class="section-title-input" 
                           placeholder="섹션 제목을 입력하세요" th:value="${section.title}">
                    <button type="button" class="btn-remove-section">삭제</button>
                </div>
                <div class="section-body">
                    <div class="chapter-list">
                        <div class="chapter-item" th:each="chapter, cStat : ${section.chapters}">
                            <div class="chapter-header">
                                <input type="text" th:name="|sections[${sStat.index}].chapters[${cStat.index}].title|" 
                                       class="chapter-input chapter-title" placeholder="챕터 제목" th:value="${chapter.title}">
                                <!-- 챕터 ID (수정 시 식별용) -->
                                <input type="hidden" th:name="|sections[${sStat.index}].chapters[${cStat.index}].chapterId|" 
                                       th:value="${chapter.chapterId}">
                                       
                                <button type="button" class="btn-remove-chapter" title="챕터 삭제">×</button>
                            </div>
                            <div class="chapter-body">
                                <input type="text" th:name="|sections[${sStat.index}].chapters[${cStat.index}].videoUrl|" 
                                       class="chapter-input chapter-url" placeholder="영상 URL" th:value="${chapter.videoUrl}">
                                
                                <div class="file-attach-area">
                                    <!-- 기존 파일 정보 hidden input -->
                                    <input type="hidden" th:name="|sections[${sStat.index}].chapters[${cStat.index}].existingFileUrl|" 
                                           th:value="${chapter.existingFileUrl}">
                                    <input type="hidden" th:name="|sections[${sStat.index}].chapters[${cStat.index}].existingFileName|" 
                                           th:value="${chapter.existingFileName}">

                                    <input type="file" th:id="|file-${sStat.index}-${cStat.index}-exist|" 
                                           th:name="|sections[${sStat.index}].chapters[${cStat.index}].file|" style="display: none;">
                                    <button type="button" class="btn-attach-file" 
                                            th:onclick="|document.getElementById('file-${sStat.index}-${cStat.index}-exist').click()|"
                                            th:text="${chapter.existingFileName != null ? '파일 변경' : '자료 첨부'}">자료 첨부</button>
                                    <span class="file-name-display" style="font-size: 1.2rem; color: #666; margin-left: 0.5rem;"
                                          th:text="${chapter.existingFileName}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-add-chapter" th:data-section-index="${sStat.index}">+ 챕터 추가</button>

                    <!-- 퀴즈 리스트 -->
                    <div class="quiz-list">
                        <div class="quiz-item" th:each="quiz, qStat : ${section.quizzes}">
                            <div class="quiz-header">
                                <span class="badge-quiz">QUIZ</span>
                                <input type="text" th:name="|sections[${sStat.index}].quizzes[${qStat.index}].title|"
                                       class="quiz-input quiz-title" placeholder="퀴즈 제목" th:value="${quiz.title}">
                                <input type="hidden" th:name="|sections[${sStat.index}].quizzes[${qStat.index}].quizId|" th:value="${quiz.quizId}">
                                <button type="button" class="btn-remove-quiz">×</button>
                            </div>
                            <div class="quiz-body">
                                <div class="question-list">
                                    <div class="question-item" th:each="question, quStat : ${quiz.questions}">
                                        <div class="question-header">
                                            <input type="text" th:name="|sections[${sStat.index}].quizzes[${qStat.index}].questions[${quStat.index}].content|"
                                                   class="question-input" placeholder="문제 내용" th:value="${question.content}">
                                            <button type="button" class="btn-remove-question">×</button>
                                        </div>
                                        <div class="question-body">
                                            <textarea th:name="|sections[${sStat.index}].quizzes[${qStat.index}].questions[${quStat.index}].explanation|"
                                                      class="question-explanation" placeholder="해설을 입력하세요" th:text="${question.explanation}"></textarea>
                                            <div class="option-list">
                                                <div class="option-item" th:each="option, oStat : ${question.options}">
                                                    <input type="radio" th:name="|sections[${sStat.index}].quizzes[${qStat.index}].questions[${quStat.index}].correctOptionIndex|"
                                                           th:value="${oStat.index}" th:checked="${option.isCorrect == 'Y'}">
                                                    <!-- isCorrect 처리는 JS로 라디오 버튼 변경 시 hidden input 업데이트 필요 -->
                                                    <input type="hidden" th:name="|sections[${sStat.index}].quizzes[${qStat.index}].questions[${quStat.index}].options[${oStat.index}].isCorrect|"
                                                           class="is-correct-input" th:value="${option.isCorrect}">
                                                    
                                                    <input type="text" th:name="|sections[${sStat.index}].quizzes[${qStat.index}].questions[${quStat.index}].options[${oStat.index}].content|"
                                                           class="option-input" placeholder="보기 내용" th:value="${option.content}">
                                                    <button type="button" class="btn-remove-option">×</button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn-add-option">+ 보기 추가</button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn-add-question">+ 문제 추가</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-add-quiz" th:data-section-index="${sStat.index}">+ 퀴즈 추가</button>
                </div>
            </div>
        </th:block>
    </div>

    <!-- 섹션 추가 버튼 -->
    <div class="add-section-area">
        <button type="button" id="btn-add-section" class="btn-add-section">+ 새 섹션 추가</button>
    </div>
    
    <!-- 파이널 퀴즈 -->
    <div class="final-quiz-area" style="margin-top: 3rem; border-top: 2px solid #ddd; padding-top: 2rem;">
        <h3>파이널 퀴즈</h3>
        <p class="help-text">강의 마지막에 진행될 종합 평가 퀴즈입니다.</p>
        <div id="final-quiz-container">
            <div class="quiz-item final-quiz-item" th:if="${course != null and course.finalQuiz != null}">
                <div class="quiz-header">
                    <span class="badge-quiz final">FINAL</span>
                    <input type="text" name="finalQuiz.title" class="quiz-input quiz-title" placeholder="파이널 퀴즈 제목" th:value="${course.finalQuiz.title}">
                    <input type="hidden" name="finalQuiz.quizId" th:value="${course.finalQuiz.quizId}">
                    <button type="button" class="btn-remove-quiz">×</button>
                </div>
                <div class="quiz-body">
                    <div class="question-list">
                         <div class="question-item" th:each="question, quStat : ${course.finalQuiz.questions}">
                            <div class="question-header">
                                <input type="text" th:name="|finalQuiz.questions[${quStat.index}].content|"
                                       class="question-input" placeholder="문제 내용" th:value="${question.content}">
                                <button type="button" class="btn-remove-question">×</button>
                            </div>
                            <div class="question-body">
                                <textarea th:name="|finalQuiz.questions[${quStat.index}].explanation|"
                                          class="question-explanation" placeholder="해설을 입력하세요" th:text="${question.explanation}"></textarea>
                                <div class="option-list">
                                    <div class="option-item" th:each="option, oStat : ${question.options}">
                                        <input type="radio" th:name="|finalQuiz.questions[${quStat.index}].correctOptionIndex|"
                                               th:value="${oStat.index}" th:checked="${option.isCorrect == 'Y'}">
                                        <input type="hidden" th:name="|finalQuiz.questions[${quStat.index}].options[${oStat.index}].isCorrect|"
                                               class="is-correct-input" th:value="${option.isCorrect}">
                                        <input type="text" th:name="|finalQuiz.questions[${quStat.index}].options[${oStat.index}].content|"
                                               class="option-input" placeholder="보기 내용" th:value="${option.content}">
                                        <button type="button" class="btn-remove-option">×</button>
                                    </div>
                                </div>
                                <button type="button" class="btn-add-option">+ 보기 추가</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn-add-question">+ 문제 추가</button>
                </div>
            </div>
            
            <div class="empty-final-quiz" th:unless="${course != null and course.finalQuiz != null}">
                <button type="button" id="btn-create-final-quiz" class="btn-add-quiz final">+ 파이널 퀴즈 생성</button>
            </div>
        </div>
    </div>
</div>
</html>
