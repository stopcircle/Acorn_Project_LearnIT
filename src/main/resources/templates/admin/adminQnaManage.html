<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/admin-layout :: layout(
        ~{::title},
        ~{::content},
        ~{::css}
      )}">

<th:block th:fragment="css">
    <link rel="stylesheet" th:href="@{/css/admin/qna.css}">
</th:block>

<head>
    <title>Q&A 관리</title>
</head>

<body>
<section th:fragment="content" class="admin-content-inner">
    <div class="admin-qna-container">
        <h2>Q&A 관리</h2>

        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

        <div class="filters">
            <form method="get" action="/admin/qna" class="filter-form">
                <select name="type" class="filter-select">
                    <option value="">구분 전체</option>
                    <option value="LECTURE" th:selected="${currentType == 'LECTURE'}">강의 Q&A</option>
                    <option value="SITE" th:selected="${currentType == 'SITE'}">전체 Q&A</option>
                </select>

                <select name="status" class="filter-select">
                    <option value="">상태 전체</option>
                    <option value="ACTIVE" th:selected="${currentStatus == 'ACTIVE'}">ACTIVE(대기)</option>
                    <option value="PASS" th:selected="${currentStatus == 'PASS'}">PASS(처리)</option>
                </select>

                <input type="text" name="search" class="search-input"
                       placeholder="강의명/작성자/제목/내용 검색" th:value="${searchKeyword}">

                <input type="hidden" name="page" value="1">
                <input type="hidden" name="size" th:value="${pageSize}">

                <button type="submit" class="btn-search">검색</button>
                <a th:href="@{/admin/qna(size=${pageSize})}" class="btn-reset">초기화</a>
            </form>
        </div>

        <div class="table-wrap">
            <table class="qna-table">
                <thead>
                <tr>
                    <th>구분</th>
                    <th>Q&A번호</th>
                    <th>강좌ID</th>
                    <th>강좌명</th>
                    <th>작성자</th>
                    <th>Q&A 상태</th>
                    <th>요약</th>
                    <th>등록일</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="q : ${qnas}">
                    <td th:text="${q.typeLabel}">강의 Q&A</td>

                    <!-- ✅ 같은 페이지에서 selectedId로 상세 펼치기 -->
                    <td>
                        <a class="link"
                           th:href="@{/admin/qna(
                                selectedId=${q.qnaId},
                                type=${currentType},
                                status=${currentStatus},
                                search=${searchKeyword},
                                page=${currentPage},
                                size=${pageSize}
                           )}"
                           th:text="${q.qnaId}">
                            1
                        </a>
                    </td>

                    <td th:text="${q.courseId != null ? q.courseId : '-'}">-</td>

                    <td>
                        <a class="link"
                           th:href="@{/admin/qna(
                                selectedId=${q.qnaId},
                                type=${currentType},
                                status=${currentStatus},
                                search=${searchKeyword},
                                page=${currentPage},
                                size=${pageSize
                           })}"
                           th:text="${q.courseTitle != null ? q.courseTitle : '-'}">-</a>
                    </td>

                    <td th:text="${q.questionUserName}">작성자</td>

                    <td>
                        <span class="badge"
                              th:classappend="${q.statusLabel == 'ACTIVE'} ? 'badge-active' : 'badge-pass'"
                              th:text="${q.statusLabel}">
                        </span>
                    </td>

                    <td class="summary"
                        th:text="${q.questionContent != null ? #strings.abbreviate(q.questionContent, 30) : '-'}">요약</td>

                    <td th:text="${q.questionCreatedAt != null ? #temporals.format(q.questionCreatedAt,'yyyy-MM-dd') : '-'}">-</td>
                </tr>

                <tr th:if="${qnas == null or #lists.isEmpty(qnas)}">
                    <td colspan="8" class="empty">Q&A가 없습니다.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- ✅ 페이지번호 5개 단위 -->
        <div class="pagination" th:if="${totalPages > 1}">
            <a th:if="${startPage > 1}"
               th:href="@{/admin/qna(page=${startPage-1}, size=${pageSize}, type=${currentType}, status=${currentStatus}, search=${searchKeyword})}"
               class="page-link">이전</a>

            <span th:each="i : ${#numbers.sequence(startPage, endPage)}" class="page-number">
                <a th:if="${i != currentPage}"
                   th:href="@{/admin/qna(page=${i}, size=${pageSize}, type=${currentType}, status=${currentStatus}, search=${searchKeyword})}"
                   th:text="${i}">1</a>
                <strong th:if="${i == currentPage}" th:text="${i}">1</strong>
            </span>

            <a th:if="${endPage < totalPages}"
               th:href="@{/admin/qna(page=${endPage+1}, size=${pageSize}, type=${currentType}, status=${currentStatus}, search=${searchKeyword})}"
               class="page-link">다음</a>
        </div>

        <div class="summary-total">
            총 <strong th:text="${totalCount}">0</strong>개
        </div>

        <!-- ==========================
             ✅ 하단 상세/수정 패널 (피그마처럼 한 페이지)
        =========================== -->
        <div class="detail-wrap" th:if="${selectedQna != null}">
            <div class="detail-head">
                <div>
                    <div class="meta">
                        <span><b>구분</b> : <span th:text="${selectedQna.typeLabel}"></span></span>
                        <span><b>작성자</b> : <span th:text="${selectedQna.questionUserName}"></span></span>
                        <span><b>이메일</b> : <span th:text="${selectedQna.questionUserEmail}"></span></span>
                        <span th:if="${selectedQna.courseTitle != null}">
                            <b>강의</b> : <span th:text="${selectedQna.courseTitle}"></span>
                        </span>
                    </div>
                    <div class="qtitle"
                         th:text="${selectedQna.questionTitle != null ? selectedQna.questionTitle : '(제목없음)'}"></div>
                </div>

                <div class="detail-actions">
                    <form th:action="@{'/admin/qna/' + ${selectedQna.qnaId} + '/delete'}"
                          method="post"
                          onsubmit="return confirm('정말 삭제하시겠습니까?');">
                        <input type="hidden" name="type" th:value="${currentType}">
                        <input type="hidden" name="status" th:value="${currentStatus}">
                        <input type="hidden" name="search" th:value="${searchKeyword}">
                        <input type="hidden" name="page" th:value="${currentPage}">
                        <input type="hidden" name="size" th:value="${pageSize}">
                        <button type="submit" class="btn-mini danger">삭제</button>
                    </form>
                </div>
            </div>

            <form th:action="@{'/admin/qna/' + ${selectedQna.qnaId} + '/status'}"
                  method="post"
                  class="status-form"
                  style="margin-bottom:12px;">
                <select name="status" class="status-select">
                    <option value="ACTIVE" th:selected="${selectedQna.statusLabel == 'ACTIVE'}">ACTIVE</option>
                    <option value="PASS" th:selected="${selectedQna.statusLabel == 'PASS'}">PASS</option>
                </select>
                <button type="submit" class="btn-mini">상태변경</button>

                <input type="hidden" name="type" th:value="${currentType}">
                <input type="hidden" name="statusFilter" th:value="${currentStatus}">
                <input type="hidden" name="search" th:value="${searchKeyword}">
                <input type="hidden" name="page" th:value="${currentPage}">
                <input type="hidden" name="size" th:value="${pageSize}">
            </form>

            <div class="detail-body">
                <div class="question-box">
                    <div class="box-title">질문</div>
                    <div class="box-content" th:text="${selectedQna.questionContent}">질문 내용</div>
                </div>

                <div class="answer-box">
                    <div class="box-title">답변</div>

                    <form th:action="@{'/admin/qna/' + ${selectedQna.qnaId} + '/answer'}"
                          method="post"
                          class="answer-form">
                        <textarea name="content" rows="6"
                                  placeholder="답변을 입력하세요"
                                  th:text="${selectedQna.answerContent}"></textarea>

                        <label class="check">
                            <input type="checkbox" name="markResolved" value="true" checked>
                            답변 저장 시 PASS 처리
                        </label>

                        <input type="hidden" name="type" th:value="${currentType}">
                        <input type="hidden" name="status" th:value="${currentStatus}">
                        <input type="hidden" name="search" th:value="${searchKeyword}">
                        <input type="hidden" name="page" th:value="${currentPage}">
                        <input type="hidden" name="size" th:value="${pageSize}">

                        <button type="submit" class="btn-primary">수정/완료</button>
                    </form>
                </div>
            </div>

            <div style="margin-top: 14px;">
                <a th:href="@{/admin/qna(type=${currentType}, status=${currentStatus}, search=${searchKeyword}, page=${currentPage}, size=${pageSize})}"
                   class="btn-reset">선택 해제</a>
            </div>
        </div>

    </div>
</section>
</body>
</html>
