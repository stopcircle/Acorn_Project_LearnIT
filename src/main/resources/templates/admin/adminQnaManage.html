<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/admin-layout :: layout(
        ~{::title},
        ~{::content},
        ~{::css},
        ~{::script}
      )}">

<th:block th:fragment="css">
    <link rel="stylesheet" th:href="@{/css/admin/qna.css}">
</th:block>

<th:block th:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", () => {

          // 1) Ìñâ ÌÅ¥Î¶≠ ‚Üí ÏïÑÏΩîÎîîÏñ∏ ÌÜ†Í∏Ä
          document.querySelectorAll("tr.main-row").forEach(row => {
            row.addEventListener("click", (e) => {
              const tag = (e.target.tagName || "").toLowerCase();
              // Ìèº ÏöîÏÜå/ÌÅ¥Î¶≠ÏòÅÏó≠ÏùÄ ÏïÑÏΩîÎîîÏñ∏ ÌÜ†Í∏Ä ÎßâÍ∏∞
              if (["button","a","select","textarea","input","label","option","form"].includes(tag)) return;

              const detail = row.nextElementSibling;
              if (!detail || !detail.classList.contains("detail-row")) return;

              detail.style.display = (detail.style.display === "table-row") ? "none" : "table-row";
            });
          });

          // 2) Íµ¨Î∂Ñ ÌïÑÌÑ∞ ÌåùÏóÖ
          document.querySelectorAll(".filter-icon").forEach(icon => {
            icon.addEventListener("click", (e) => {
              e.stopPropagation();
              const key = icon.dataset.key;
              const popup = document.querySelector(`.filter-popup[data-popup="${key}"]`);
              if (!popup) return;

              document.querySelectorAll(".filter-popup").forEach(p => {
                if (p !== popup) p.style.display = "none";
              });

              popup.style.display = (popup.style.display === "block") ? "none" : "block";
            });
          });

          // 3) ‚úÖ ÏÉÅÌÉú Î∞∞ÏßÄ ÌÅ¥Î¶≠ ‚Üí "Ìï¥Îãπ Ìñâ ÏÉÅÌÉú Î≥ÄÍ≤Ω" ÌåùÏóÖ ÌÜ†Í∏Ä (ÌïÑÌÑ∞ X)
          document.querySelectorAll(".status-badge-wrap").forEach(wrap => {
            const badge = wrap.querySelector(".status-badge-click");
            const popup = wrap.querySelector(".status-action-popup");
            if (!badge || !popup) return;

            badge.addEventListener("click", (e) => {
              e.stopPropagation();
              document.querySelectorAll(".status-action-popup").forEach(p => {
                if (p !== popup) p.style.display = "none";
              });
              popup.style.display = (popup.style.display === "block") ? "none" : "block";
            });

            // ÌåùÏóÖ ÎÇ¥Î∂Ä ÌÅ¥Î¶≠ÏùÄ Î∞îÍπ•ÌÅ¥Î¶≠ Îã´Í∏∞ Î∞©ÏßÄ
            popup.addEventListener("click", (e) => e.stopPropagation());
          });

          // Î∞îÍπ• ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
          document.addEventListener("click", () => {
            document.querySelectorAll(".filter-popup").forEach(p => p.style.display = "none");
            document.querySelectorAll(".status-action-popup").forEach(p => p.style.display = "none");
          });
        });
    </script>
</th:block>

<head>
    <title>Q&A Í¥ÄÎ¶¨</title>
</head>

<body>
<section th:fragment="content" class="admin-content-inner">
    <div class="admin-qna-container">
        <h2>Q&A Í¥ÄÎ¶¨</h2>

        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

        <!-- ÏÉÅÎã® Í≤ÄÏÉâ ÏòÅÏó≠ -->
        <div class="filters">
            <form method="get" th:action="@{/admin/qna}" class="filter-form">

                <!-- ‚úÖ Q&AÎ≤àÌò∏: ÎìúÎ°≠Îã§Ïö¥ -->
                <select name="qnaId" class="qnaid-select">
                    <option value="" th:selected="${qnaIdFilter == null}">Q&AÎ≤àÌò∏</option>
                    <option th:each="id : ${qnaIdOptions}"
                            th:value="${id}"
                            th:text="${id}"
                            th:selected="${qnaIdFilter != null and qnaIdFilter == id}">
                    </option>
                </select>

                <!-- type/status Ïú†ÏßÄ -->
                <input type="hidden" name="type" th:value="${currentType}">
                <input type="hidden" name="status" th:value="${currentStatus}">

                <input type="text" name="search" class="search-input"
                       placeholder="Í∞ïÏùòÎ™Ö/ÏûëÏÑ±Ïûê/Ï†úÎ™©/ÎÇ¥Ïö© Í≤ÄÏÉâ"
                       th:value="${searchKeyword}">

                <input type="hidden" name="page" value="1">
                <input type="hidden" name="size" th:value="${pageSize}">

                <button type="submit" class="btn-search">Í≤ÄÏÉâ</button>
                <a th:href="@{/admin/qna(size=${pageSize})}" class="btn-reset">Ï¥àÍ∏∞Ìôî</a>

                <th:block th:if="${isSubAdmin and !isAdmin}">
                    <span class="role-hint">SUB_ADMIN: Í∞ïÏùò Q&AÎßå Ï≤òÎ¶¨ Í∞ÄÎä•</span>
                </th:block>
            </form>
        </div>

        <div class="table-wrap">
            <table class="qna-table">
                <thead>
                <tr>
                    <!-- Íµ¨Î∂Ñ + ÌïÑÌÑ∞ -->
                    <th class="th-filter">
                        Íµ¨Î∂Ñ
                        <span class="filter-icon" data-key="type">üîΩ</span>
                        <div class="filter-popup" data-popup="type">
                            <a class="popup-link"
                               th:href="@{/admin/qna(page=1,size=${pageSize},type=LECTURE,status=${currentStatus},search=${searchKeyword},qnaId=${qnaIdFilter})}">
                                Í∞ïÏùò Q&A
                            </a>

                            <a class="popup-link"
                               th:href="@{/admin/qna(page=1,size=${pageSize},type=SITE,status=${currentStatus},search=${searchKeyword},qnaId=${qnaIdFilter})}"
                               th:if="${isAdmin}">
                                Ï†ÑÏ≤¥ Q&A
                            </a>

                            <a class="popup-link"
                               th:href="@{/admin/qna(page=1,size=${pageSize},type=,status=${currentStatus},search=${searchKeyword},qnaId=${qnaIdFilter})}"
                               th:if="${isAdmin}">
                                Ï†ÑÏ≤¥(Í∞ïÏùò+Ï†ÑÏ≤¥)
                            </a>
                        </div>
                    </th>

                    <th>Q&AÎ≤àÌò∏</th>
                    <th>Í∞ïÏ¢åÎ™Ö/Ï†úÎ™©</th>
                    <th>ÏûëÏÑ±Ïûê</th>
                    <th>ÏÉÅÌÉú</th>
                    <th>Îì±Î°ùÏùº</th>
                </tr>
                </thead>

                <tbody>
                <th:block th:each="q : ${qnas}">

                    <!-- Î©îÏù∏ Ìñâ -->
                    <tr class="main-row">
                        <td th:text="${q.typeLabel}">Í∞ïÏùò Q&A</td>
                        <td th:text="${q.qnaId}">1</td>

                        <td class="title-cell"
                            th:text="${q.courseId != null
                                    ? (q.courseTitle + ' / ' + (q.questionTitle != null ? q.questionTitle : '(Ï†úÎ™©ÏóÜÏùå)'))
                                    : (q.questionTitle != null ? q.questionTitle : 'Ï†ÑÏ≤¥ Q&A')}">
                            -
                        </td>

                        <td th:text="${q.questionUserName}">ÏûëÏÑ±Ïûê</td>

                        <!-- ‚úÖ ÏÉÅÌÉú Î∞∞ÏßÄ ÌÅ¥Î¶≠ ‚Üí Ìï¥Îãπ row ÏÉÅÌÉúÎßå Î≥ÄÍ≤Ω (ÌïÑÌÑ∞ X) -->
                        <td>
                            <div class="status-badge-wrap"
                                 th:classappend="${isAdmin or isSubAdmin} ? 'can-click' : ''">

                                <span class="badge status-badge-click"
                                      th:classappend="${q.statusLabel == 'ACTIVE'} ? 'badge-active' : 'badge-pass'"
                                      th:text="${q.statusLabel}">
                                </span>

                                <!-- ‚úÖ Í∂åÌïú ÏûàÏùÑ ÎïåÎßå: ÏÉÅÌÉú Î≥ÄÍ≤Ω ÌåùÏóÖ -->
                                <div class="status-action-popup" th:if="${isAdmin or (isSubAdmin and q.courseId != null)}">
                                    <form th:action="@{'/admin/qna/' + ${q.qnaId} + '/status'}" method="post" class="status-action-form">
                                        <input type="hidden" name="type" th:value="${currentType}">
                                        <input type="hidden" name="status" th:value="${currentStatus}">
                                        <input type="hidden" name="search" th:value="${searchKeyword}">
                                        <input type="hidden" name="qnaId" th:value="${qnaIdFilter}">
                                        <input type="hidden" name="page" th:value="${currentPage}">
                                        <input type="hidden" name="size" th:value="${pageSize}">

                                        <button type="submit" name="newStatus" value="ACTIVE" class="popup-btn">
                                            ACTIVEÎ°ú Î≥ÄÍ≤Ω
                                        </button>
                                        <button type="submit" name="newStatus" value="PASS" class="popup-btn">
                                            PASSÎ°ú Î≥ÄÍ≤Ω
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </td>

                        <td th:text="${q.questionCreatedAt != null ? #temporals.format(q.questionCreatedAt,'yyyy-MM-dd') : '-'}">-</td>
                    </tr>

                    <!-- ÏÉÅÏÑ∏ ÏïÑÏΩîÎîîÏñ∏ Ìñâ -->
                    <tr class="detail-row" style="display:none;">
                        <td colspan="6">
                            <div class="detail-inner">
                                <div class="detail-meta">
                                    <span><b>Íµ¨Î∂Ñ</b> : <span th:text="${q.typeLabel}"></span></span>
                                    <span><b>ÏûëÏÑ±Ïûê</b> : <span th:text="${q.questionUserName}"></span></span>
                                    <span><b>Ïù¥Î©îÏùº</b> : <span th:text="${q.questionUserEmail}"></span></span>
                                    <span th:if="${q.courseTitle != null}">
                                        <b>Í∞ïÏùò</b> : <span th:text="${q.courseTitle}"></span>
                                    </span>
                                </div>

                                <div class="detail-title" th:text="${q.questionTitle != null ? q.questionTitle : '(Ï†úÎ™©ÏóÜÏùå)'}"></div>

                                <div class="detail-body">
                                    <div class="question-box">
                                        <div class="box-title">ÏßàÎ¨∏</div>
                                        <div class="box-content" th:text="${q.questionContent}">ÏßàÎ¨∏ ÎÇ¥Ïö©</div>
                                    </div>

                                    <div class="answer-box">
                                        <div class="box-title">ÎãµÎ≥Ä</div>

                                        <th:block th:if="${isAdmin or (isSubAdmin and q.courseId != null)}">
                                            <form th:action="@{'/admin/qna/' + ${q.qnaId} + '/save'}"
                                                  method="post" class="answer-form">

                                                <textarea name="content" rows="6"
                                                          placeholder="ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                                          th:text="${q.answerContent}"></textarea>

                                                <div class="status-inline">
                                                    <label class="status-label">ÏÉÅÌÉú</label>
                                                    <select name="newStatus" class="status-select">
                                                        <option value="ACTIVE" th:selected="${q.statusLabel == 'ACTIVE'}">ACTIVE</option>
                                                        <option value="PASS" th:selected="${q.statusLabel == 'PASS'}">PASS</option>
                                                    </select>
                                                </div>

                                                <input type="hidden" name="type" th:value="${currentType}">
                                                <input type="hidden" name="status" th:value="${currentStatus}">
                                                <input type="hidden" name="search" th:value="${searchKeyword}">
                                                <input type="hidden" name="qnaId" th:value="${qnaIdFilter}">
                                                <input type="hidden" name="page" th:value="${currentPage}">
                                                <input type="hidden" name="size" th:value="${pageSize}">

                                                <div class="btn-row">
                                                    <button type="submit" class="btn-primary">ÏàòÏ†ï</button>

                                                    <button type="submit"
                                                            class="btn-mini danger"
                                                            th:formaction="@{'/admin/qna/' + ${q.qnaId} + '/delete'}"
                                                            formmethod="post"
                                                            onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">
                                                        ÏÇ≠Ï†ú
                                                    </button>
                                                </div>
                                            </form>
                                        </th:block>

                                        <th:block th:if="${!(isAdmin or (isSubAdmin and q.courseId != null))}">
                                            <div class="box-content"
                                                 th:text="${q.answerContent != null ? q.answerContent : 'Îì±Î°ùÎêú ÎãµÎ≥ÄÏù¥ ÏóÜÏäµÎãàÎã§.'}"></div>
                                            <div class="no-permission">Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.</div>
                                        </th:block>

                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>

                </th:block>

                <tr th:if="${qnas == null or #lists.isEmpty(qnas)}">
                    <td colspan="6" class="empty">Q&AÍ∞Ä ÏóÜÏäµÎãàÎã§.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- ÌéòÏù¥Ïßï -->
        <div class="pagination" th:if="${totalPages > 1}">
            <a th:if="${startPage > 1}"
               th:href="@{/admin/qna(page=${startPage-1}, size=${pageSize}, type=${currentType}, status=${currentStatus}, search=${searchKeyword}, qnaId=${qnaIdFilter})}"
               class="page-link">Ïù¥Ï†Ñ</a>

            <span th:each="i : ${#numbers.sequence(startPage, endPage)}" class="page-number">
                <a th:if="${i != currentPage}"
                   th:href="@{/admin/qna(page=${i}, size=${pageSize}, type=${currentType}, status=${currentStatus}, search=${searchKeyword}, qnaId=${qnaIdFilter})}"
                   th:text="${i}">1</a>
                <strong th:if="${i == currentPage}" th:text="${i}">1</strong>
            </span>

            <a th:if="${endPage < totalPages}"
               th:href="@{/admin/qna(page=${endPage+1}, size=${pageSize}, type=${currentType}, status=${currentStatus}, search=${searchKeyword}, qnaId=${qnaIdFilter})}"
               class="page-link">Îã§Ïùå</a>
        </div>

        <div class="summary-total">
            Ï¥ù <strong th:text="${totalCount}">0</strong>Í∞ú
        </div>

    </div>
</section>
</body>
</html>
