<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/admin-layout :: layout(
        ~{::title},
        ~{::content},
        ~{::css},
        ~{::script}
      )}">

<th:block th:fragment="css">
  <link rel="stylesheet" th:href="@{/css/admin/review.css}">
</th:block>

<th:block th:fragment="script">
  <script th:src="@{/js/admin/review.js}"></script>
</th:block>

<head>
  <title>리뷰 관리</title>
</head>
<body>
<section th:fragment="content">
  <div class="admin-review-container">
    <h2>리뷰 관리</h2>

    <!-- 성공/에러 메시지 -->
    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

    <!-- 검색 및 필터 -->
    <div class="review-filters">
      <form method="get" action="/admin/review" class="filter-form" id="filterForm">
        <input type="hidden" name="commentStatus" th:value="${currentCommentStatus}">
        <select name="searchType" class="filter-select">
          <option value="">선택</option>
          <option value="courseId" th:selected="${currentSearchType == 'courseId'}">강좌 ID</option>
          <option value="courseTitle" th:selected="${currentSearchType == 'courseTitle'}">강좌명</option>
          <option value="userName" th:selected="${currentSearchType == 'userName'}">작성자</option>
        </select>
        <input type="text" name="search" placeholder="검색어 입력" 
               th:value="${searchKeyword}" class="search-input">
        <button type="submit" class="btn-search">검색</button>
        <a href="/admin/review" class="btn-reset">초기화</a>
      </form>
    </div>

    <!-- 리뷰 목록 -->
    <div class="review-list">
      <table class="review-table">
        <thead>
          <tr>
            <th>리뷰번호</th>
            <th>강좌ID</th>
            <th>강좌명</th>
            <th>작성자</th>
            <th>평점</th>
            <th>
              <div class="status-filter-header">
                <span class="status-filter-label"
                      onclick="toggleStatusFilter(event)">
                  댓글 상태
                  <span class="filter-indicator" th:if="${currentCommentStatus != null and currentCommentStatus != ''}">●</span>
                </span>
                <div id="statusFilterDropdown" class="status-filter-dropdown">
                  <div class="filter-option"
                       onclick="filterByStatus('')"
                       th:classappend="${currentCommentStatus == null or currentCommentStatus == ''} ? 'active' : ''">
                    전체
                  </div>
                  <div class="filter-option"
                       onclick="filterByStatus('Active')"
                       th:classappend="${currentCommentStatus == 'Active'} ? 'active' : ''">
                    Active
                  </div>
                  <div class="filter-option"
                       onclick="filterByStatus('Approved')"
                       th:classappend="${currentCommentStatus == 'Approved'} ? 'active' : ''">
                    Approved
                  </div>
                  <div class="filter-option"
                       onclick="filterByStatus('Rejected')"
                       th:classappend="${currentCommentStatus == 'Rejected'} ? 'active' : ''">
                    Rejected
                  </div>
                </div>
              </div>
            </th>
            <th>요약</th>
            <th>등록일</th>
            <th>수정일</th>
            <th>관리</th>
          </tr>
        </thead>
        <tbody>
          <th:block th:each="review : ${reviews}">
          <tr class="review-row clickable-row" 
              th:attr="data-review-id=${review.reviewId}"
              onclick="toggleAccordionByRow(this)">
            <td th:text="${review.reviewId}">1</td>
            <td th:text="${review.courseId}">1</td>
            <td onclick="event.stopPropagation();">
              <a th:href="@{'/admin/review/' + ${review.reviewId}}" class="course-link" 
                 th:text="${review.courseTitle != null ? review.courseTitle : '강의명 없음'}">강의명</a>
              <span th:if="${review.courseId != null}">
                <a th:href="@{'/CourseDetail?courseId=' + ${review.courseId}}" 
                   target="_blank" 
                   class="course-detail-link">
                  [강의 상세보기]
                </a>
              </span>
            </td>
            <td th:text="${review.userName != null ? review.userName : '작성자 없음'}">작성자</td>
            <td>
              <span class="rating" th:text="'★ ' + ${review.rating != null ? review.rating : 0}">★ 5</span>
            </td>
            <td>
              <span class="status-badge" 
                    th:classappend="${review.commentStatus == 'Active'} ? 'status-active' : 
                                   (${review.commentStatus == 'Approved'} ? 'status-approved' : 'status-rejected')"
                    th:text="${review.commentStatus != null ? review.commentStatus : 'Active'}">Active</span>
            </td>
            <td class="comment-cell">
              <span th:text="${review.comment != null ? #strings.abbreviate(review.comment, 50) : '내용 없음'}">리뷰 내용...</span>
            </td>
            <td th:text="${review.createdAt != null ? #temporals.format(review.createdAt, 'yyyy-MM-dd') : '-'}">2024-01-01</td>
            <td th:text="${review.updatedAt != null ? #temporals.format(review.updatedAt, 'yyyy-MM-dd') : '-'}">-</td>
            <td class="action-cell" onclick="event.stopPropagation();">
              <div class="action-buttons">
                <form th:action="@{'/admin/review/' + ${review.reviewId} + '/delete'}" 
                      method="post" style="display: inline;"
                      onsubmit="return confirm('정말 삭제하시겠습니까?');">
                  <input type="hidden" name="page" th:value="${currentPage}">
                  <input type="hidden" name="searchType" th:value="${currentSearchType}">
                  <input type="hidden" name="search" th:value="${searchKeyword}">
                  <input type="hidden" name="commentStatus" th:value="${currentCommentStatus}">
                  <button type="submit" class="btn-delete">삭제</button>
                </form>
              </div>
            </td>
          </tr>
          <tr class="accordion-row" th:attr="data-review-id=${review.reviewId}">
            <td colspan="10" class="accordion-content">
              <div class="accordion-panel">
                <!-- 편집 폼 -->
                <div class="detail-section">
                  <h3>리뷰 수정</h3>
                  <form th:action="@{'/admin/review/' + ${review.reviewId} + '/update'}" method="post" class="review-edit-form">
                    <input type="hidden" name="page" th:value="${currentPage}">
                    <input type="hidden" name="searchType" th:value="${currentSearchType}">
                    <input type="hidden" name="search" th:value="${searchKeyword}">
                    <input type="hidden" name="filterCommentStatus" th:value="${currentCommentStatus}">
                    <div class="form-group">
                      <label th:attr="for='content-' + ${review.reviewId}">리뷰 내용</label>
                      <textarea name="content" th:attr="id='content-' + ${review.reviewId}" class="form-control" rows="5" required
                                th:text="${review.comment != null ? review.comment : ''}"></textarea>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label th:attr="for='rating-' + ${review.reviewId}">평점</label>
                        <input type="hidden" name="rating" th:value="${review.rating != null ? review.rating : 0}">
                        <select th:attr="id='rating-' + ${review.reviewId}" class="form-control" disabled>
                          <option value="1" th:selected="${review.rating == 1}">1</option>
                          <option value="2" th:selected="${review.rating == 2}">2</option>
                          <option value="3" th:selected="${review.rating == 3}">3</option>
                          <option value="4" th:selected="${review.rating == 4}">4</option>
                          <option value="5" th:selected="${review.rating == 5}">5</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label th:attr="for='commentStatus-' + ${review.reviewId}">상태</label>
                        <select name="commentStatus" th:attr="id='commentStatus-' + ${review.reviewId}" class="form-control" required>
                          <option value="Active" th:selected="${review.commentStatus == 'Active'}">Active</option>
                          <option value="Approved" th:selected="${review.commentStatus == 'Approved'}">Approved</option>
                          <option value="Rejected" th:selected="${review.commentStatus == 'Rejected'}">Rejected</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-actions">
                      <button type="submit" class="btn-save">저장</button>
                      <button type="button" class="btn-cancel" 
                              th:attr="data-review-id=${review.reviewId}"
                              onclick="toggleAccordion(this)">취소</button>
                    </div>
                  </form>
                </div>

                <!-- 액션 버튼들 -->
                <div class="detail-actions">
                  <form th:action="@{'/admin/review/' + ${review.reviewId} + '/approve'}" method="post" style="display: inline;">
                    <input type="hidden" name="page" th:value="${currentPage}">
                    <input type="hidden" name="searchType" th:value="${currentSearchType}">
                    <input type="hidden" name="search" th:value="${searchKeyword}">
                    <input type="hidden" name="commentStatus" th:value="${currentCommentStatus}">
                    <button type="submit" class="btn-approve">승인(APPROVE)</button>
                  </form>
                  <form th:action="@{'/admin/review/' + ${review.reviewId} + '/reject'}" method="post" style="display: inline;">
                    <input type="hidden" name="page" th:value="${currentPage}">
                    <input type="hidden" name="searchType" th:value="${currentSearchType}">
                    <input type="hidden" name="search" th:value="${searchKeyword}">
                    <input type="hidden" name="commentStatus" th:value="${currentCommentStatus}">
                    <button type="submit" class="btn-reject">거부(REJECT)</button>
                  </form>
                  <form th:action="@{'/admin/review/' + ${review.reviewId} + '/update-status'}" method="post" style="display: inline;">
                    <input type="hidden" name="status" value="Active">
                    <input type="hidden" name="page" th:value="${currentPage}">
                    <input type="hidden" name="searchType" th:value="${currentSearchType}">
                    <input type="hidden" name="search" th:value="${searchKeyword}">
                    <input type="hidden" name="commentStatus" th:value="${currentCommentStatus}">
                    <button type="submit" class="btn-pass">대기(PASS)</button>
                  </form>
                  <form th:action="@{'/admin/review/' + ${review.reviewId} + '/delete'}" method="post" style="display: inline;"
                        onsubmit="return confirm('정말 삭제하시겠습니까?');">
                    <input type="hidden" name="page" th:value="${currentPage}">
                    <input type="hidden" name="searchType" th:value="${currentSearchType}">
                    <input type="hidden" name="search" th:value="${searchKeyword}">
                    <input type="hidden" name="commentStatus" th:value="${currentCommentStatus}">
                    <button type="submit" class="btn-delete">삭제</button>
                  </form>
                </div>
              </div>
            </td>
          </tr>
          </th:block>
          <tr th:if="${reviews == null or #lists.isEmpty(reviews)}">
            <td colspan="10" class="empty-message">등록된 리뷰가 없습니다.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 페이징 -->
    <div class="pagination" th:if="${totalPages > 1}">
      <a th:if="${startPage > 1}"
         th:href="@{/admin/review(page=${startPage - 1}, size=${pageSize}, searchType=${currentSearchType}, search=${searchKeyword}, commentStatus=${currentCommentStatus})}"
         class="page-link">이전</a>
      <span th:each="i : ${#numbers.sequence(startPage, endPage)}" class="page-number">
        <a th:if="${i != currentPage}" 
           th:href="@{/admin/review(page=${i}, size=${pageSize}, searchType=${currentSearchType}, search=${searchKeyword}, commentStatus=${currentCommentStatus})}"
           th:text="${i}">1</a>
        <strong th:if="${i == currentPage}" th:text="${i}">1</strong>
      </span>
      <a th:if="${endPage < totalPages}"
         th:href="@{/admin/review(page=${endPage + 1}, size=${pageSize}, searchType=${currentSearchType}, search=${searchKeyword}, commentStatus=${currentCommentStatus})}"
         class="page-link">다음</a>
    </div>

    <div class="review-summary">
      <p>총 <strong th:text="${totalCount}">0</strong>개의 리뷰</p>
    </div>
  </div>

</section>
</body>
</html>
