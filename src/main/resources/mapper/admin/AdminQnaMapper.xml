<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learnit.learnit.admin.qna.AdminQnaRepository">

    <!-- ✅ "관리자(ADMIN) 또는 해당 강의 SUB_ADMIN"인지 검사 -->
    <sql id="isStaffForThisQna">
        EXISTS (
        SELECT 1
        FROM admin_user_role aur
        JOIN admin_role ar ON aur.admin_role_id = ar.admin_role_id
        WHERE aur.user_id = a2.user_id
        AND (
        ar.code = 'ADMIN'
        OR (ar.code = 'SUB_ADMIN' AND aur.course_id = q.course_id)
        )
        )
    </sql>

    <!-- ✅ 최신 답변: "학생 댓글" 제외, ADMIN/SUB_ADMIN 답변만 -->
    <sql id="latestStaffAnswerJoin">
        LEFT JOIN qna_answer a
        ON a.answer_id = (
        SELECT a2.answer_id
        FROM qna_answer a2
        WHERE a2.qna_id = q.qna_id
        AND a2.delete_flg = 0
        AND <include refid="isStaffForThisQna"/>
        ORDER BY a2.created_at DESC
        LIMIT 1
        )
        LEFT JOIN users au ON a.user_id = au.user_id
    </sql>

    <sql id="baseWhere">
        q.delete_flg = 0

        <if test="type != null and type != ''">
            <choose>
                <when test="type == 'SITE'">
                    AND q.course_id IS NULL
                </when>
                <when test="type == 'LECTURE'">
                    AND q.course_id IS NOT NULL
                </when>
            </choose>
        </if>

        <if test="status != null and status != ''">
            <choose>
                <when test="status == 'ACTIVE'">
                    AND q.is_resolved = 'N'
                </when>
                <when test="status == 'PASS'">
                    AND q.is_resolved = 'Y'
                </when>
            </choose>
        </if>

        <!-- ✅ SUB_ADMIN 전용 필터: 본인 강의만 -->
        <if test="instructorUserId != null">
            AND q.course_id IS NOT NULL
            AND c.user_id = #{instructorUserId}
        </if>

        <!-- ✅ 검색 -->
        <if test="searchField == 'QNA_ID'">
            <if test="searchQnaId != null">
                AND q.qna_id = #{searchQnaId}
            </if>
        </if>

        <if test="searchField != null and searchField != '' and search != null and search != '' and searchField != 'QNA_ID'">
            <choose>
                <when test="searchField == 'WRITER'">
                    AND LOWER(qu.name) LIKE CONCAT('%', LOWER(#{search}), '%')
                </when>

                <when test="searchField == 'TITLE'">
                    AND (
                    LOWER(IFNULL(c.title,'')) LIKE CONCAT('%', LOWER(#{search}), '%')
                    OR LOWER(IFNULL(q.title,'')) LIKE CONCAT('%', LOWER(#{search}), '%')
                    OR LOWER(IFNULL(q.content,'')) LIKE CONCAT('%', LOWER(#{search}), '%')
                    )
                </when>

                <otherwise>
                    AND (
                    LOWER(IFNULL(q.title,'')) LIKE CONCAT('%', LOWER(#{search}), '%')
                    OR LOWER(IFNULL(q.content,'')) LIKE CONCAT('%', LOWER(#{search}), '%')
                    OR LOWER(IFNULL(qu.name,'')) LIKE CONCAT('%', LOWER(#{search}), '%')
                    OR LOWER(IFNULL(c.title,'')) LIKE CONCAT('%', LOWER(#{search}), '%')
                    )
                </otherwise>
            </choose>
        </if>
    </sql>

    <select id="selectQnas" resultType="com.learnit.learnit.admin.qna.AdminQnaDTO">
        SELECT
        q.qna_id AS qnaId,
        q.course_id AS courseId,
        c.title AS courseTitle,

        q.user_id AS questionUserId,
        qu.name AS questionUserName,
        qu.email AS questionUserEmail,

        q.title AS questionTitle,
        q.content AS questionContent,
        q.created_at AS questionCreatedAt,
        q.is_resolved AS isResolved,

        a.answer_id AS answerId,
        a.user_id AS answerUserId,
        au.name AS answerUserName,
        a.content AS answerContent,
        a.created_at AS answerCreatedAt

        FROM qna_question q
        LEFT JOIN course c ON q.course_id = c.course_id
        JOIN users qu ON q.user_id = qu.user_id

        <include refid="latestStaffAnswerJoin"/>

        <where>
            <include refid="baseWhere"/>
        </where>

        ORDER BY q.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countQnas" resultType="int">
        SELECT COUNT(*)
        FROM qna_question q
        LEFT JOIN course c ON q.course_id = c.course_id
        JOIN users qu ON q.user_id = qu.user_id
        <where>
            <include refid="baseWhere"/>
        </where>
    </select>

    <select id="selectQnaDetail" resultType="com.learnit.learnit.admin.qna.AdminQnaDTO">
        SELECT
        q.qna_id AS qnaId,
        q.course_id AS courseId,
        c.title AS courseTitle,

        q.user_id AS questionUserId,
        qu.name AS questionUserName,
        qu.email AS questionUserEmail,

        q.title AS questionTitle,
        q.content AS questionContent,
        q.created_at AS questionCreatedAt,
        q.is_resolved AS isResolved,

        a.answer_id AS answerId,
        a.user_id AS answerUserId,
        au.name AS answerUserName,
        a.content AS answerContent,
        a.created_at AS answerCreatedAt

        FROM qna_question q
        LEFT JOIN course c ON q.course_id = c.course_id
        JOIN users qu ON q.user_id = qu.user_id

        <include refid="latestStaffAnswerJoin"/>

        WHERE q.qna_id = #{qnaId}
        AND q.delete_flg = 0
    </select>

    <!-- ✅ 관리자/서브관리자 답변만 최신으로 잡기 -->
    <select id="selectLatestStaffAnswerId" resultType="java.lang.Integer">
        SELECT a.answer_id
        FROM qna_answer a
        JOIN qna_question q ON q.qna_id = a.qna_id
        WHERE a.qna_id = #{qnaId}
        AND a.delete_flg = 0
        AND q.delete_flg = 0
        AND EXISTS (
        SELECT 1
        FROM admin_user_role aur
        JOIN admin_role ar ON aur.admin_role_id = ar.admin_role_id
        WHERE aur.user_id = a.user_id
        AND (
        ar.code = 'ADMIN'
        OR (ar.code = 'SUB_ADMIN' AND aur.course_id = q.course_id)
        )
        )
        ORDER BY a.created_at DESC
        LIMIT 1
    </select>

    <insert id="insertAnswer">
        INSERT INTO qna_answer (qna_id, user_id, parent_answer_id, content, created_at, updated_at, delete_flg)
        VALUES (#{qnaId}, #{userId}, NULL, #{content}, NOW(), NOW(), 0)
    </insert>

    <update id="updateAnswer">
        UPDATE qna_answer
        SET content = #{content},
        updated_at = NOW()
        WHERE answer_id = #{answerId}
    </update>

    <update id="updateResolved">
        UPDATE qna_question
        SET is_resolved = #{isResolved},
        updated_at = NOW()
        WHERE qna_id = #{qnaId}
    </update>

    <update id="softDeleteAnswersByQnaId">
        UPDATE qna_answer
        SET delete_flg = 1,
        updated_at = NOW()
        WHERE qna_id = #{qnaId}
    </update>

    <update id="softDeleteQuestionById">
        UPDATE qna_question
        SET delete_flg = 1,
        updated_at = NOW()
        WHERE qna_id = #{qnaId}
    </update>

    <select id="selectInstructorUserIdByCourseId" resultType="java.lang.Long">
        SELECT user_id
        FROM course
        WHERE course_id = #{courseId}
        LIMIT 1
    </select>

</mapper>
