<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learnit.learnit.courseVideo.repository.CourseVideoMapper">
    <select id="findById" resultType="com.learnit.learnit.courseVideo.dto.CourseVideo">
        SELECT
            chapter_id,
            course_id,
            title,
            order_index,
            video_url,
            duration_sec,
            section_title  FROM chapter
        WHERE chapter_id = #{chapterId}
    </select>

    <select id="selectPrevChapterId" resultType="Long">
        SELECT chapter_id
        FROM chapter
        WHERE course_id = #{courseId}
          AND order_index &lt; #{orderIndex}  ORDER BY order_index DESC
            LIMIT 1
    </select>

    <select id="selectNextChapterId" resultType="Long">
        SELECT chapter_id
        FROM chapter
        WHERE course_id = #{courseId}
          AND order_index &gt; #{orderIndex}  ORDER BY order_index ASC
            LIMIT 1
    </select>

    <insert id="insertOrUpdateStudyLog">
        INSERT INTO study_log (
            user_id,
            course_id,
            chapter_id,
            studied_sec,
            created_at
        ) VALUES (
                     #{userId},
                     #{courseId},
                     #{chapterId},
                     #{playTime},
                     NOW()
                 )
            ON DUPLICATE KEY UPDATE
                                 studied_sec = #{playTime},
                                 created_at = NOW()
    </insert>

    <select id="countTotalChapters" resultType="int">
        SELECT COUNT(*) FROM chapter WHERE course_id = #{courseId}
    </select>

    <!-- duration_sec > 0인 챕터 수 카운트 (수료증 발급용) -->
    <select id="countTotalChaptersWithDuration" resultType="int">
        SELECT COUNT(*) 
        FROM chapter 
        WHERE course_id = #{courseId}
          AND duration_sec > 0
    </select>

    <!-- 95% 이상 수강한 챕터 수 (수료증 발급용) - JOIN으로 개선 -->
    <select id="countCompletedChapters" resultType="int">
        SELECT COUNT(DISTINCT sl.chapter_id)
        FROM study_log sl
        JOIN chapter ch ON sl.chapter_id = ch.chapter_id
        WHERE sl.user_id = #{userId}
          AND sl.course_id = #{courseId}
          AND ch.duration_sec > 0
          AND (sl.studied_sec / ch.duration_sec) >= 0.95
    </select>

    <update id="updateChapterDuration">
        UPDATE chapter
        SET duration_sec = #{duration}
        WHERE chapter_id = #{chapterId}
          AND (duration_sec IS NULL OR duration_sec = 0)
    </update>

    <select id="selectChapterList" resultType="com.learnit.learnit.courseVideo.dto.CourseVideo">
        SELECT
            c.chapter_id AS chapterId,
            c.course_id AS courseId,
            c.title,
            c.order_index AS orderIndex,
            c.video_url AS videoUrl,
            c.duration_sec AS durationSec,
            c.section_title AS sectionTitle

        FROM chapter c
        WHERE c.course_id = #{courseId}
        ORDER BY c.order_index ASC
    </select>

    <resultMap id="CourseFileMap" type="com.learnit.learnit.courseVideo.dto.CourseFile">
        <result property="chapterId" column="chapter_id"/>
        <result property="title" column="title"/>
        <result property="fileUrl" column="file_url"/>
        <result property="fileType" column="file_type"/>
    </resultMap>

    <select id="selectCourseResources" resultMap="CourseFileMap">
        SELECT
            r.chapter_id,
            r.title,
            r.file_url,
            r.file_type
        FROM chapter_resource r
                 JOIN chapter c ON r.chapter_id = c.chapter_id
        WHERE c.course_id = #{courseId}
        ORDER BY c.order_index ASC
    </select>

    <select id="selectEnrollmentStatus" resultType="String">
        SELECT status
        FROM enrollment
        WHERE user_id = #{userId}
          AND course_id = #{courseId}
    </select>

    <select id="selectCourseInstructorId" resultType="Long">
        SELECT user_id
        FROM course
        WHERE course_id = #{courseId}
    </select>

    <!-- 인터프리터 실행 로그 저장 -->
    <insert id="insertInterpreterLog">
        INSERT INTO interpreter_log (
            user_id,
            course_id,
            chapter_id,
            language_id,
            executed_at
        ) VALUES (
            #{userId},
            #{courseId},
            #{chapterId},
            #{languageId},
            NOW()
        )
    </insert>

    <select id="selectFirstChapterId" resultType="Long">
        SELECT chapter_id
        FROM chapter
        WHERE course_id = #{courseId}
        ORDER BY order_index ASC
        LIMIT 1
    </select>

    <!-- enrollment_id 조회 -->
    <select id="selectEnrollmentId" resultType="Long">
        SELECT enrollment_id
        FROM enrollment
        WHERE user_id = #{userId}
          AND course_id = #{courseId}
        LIMIT 1
    </select>

    <!-- enrollment 완강 처리 (completed_at 업데이트) -->
    <update id="updateEnrollmentCompleted">
        UPDATE enrollment
        SET completed_at = NOW(),
            progress_rate = 100
        WHERE enrollment_id = #{enrollmentId}
          AND completed_at IS NULL
    </update>

    <!-- 수료증 존재 여부 확인 -->
    <select id="existsCertificate" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM certificate
        WHERE enrollment_id = #{enrollmentId}
    </select>

    <!-- 사용자가 수강 중인 모든 강의 ID 조회 -->
    <select id="selectEnrolledCourseIds" resultType="Long">
        SELECT DISTINCT course_id
        FROM enrollment
        WHERE user_id = #{userId}
          AND status = 'ACTIVE'
    </select>

    <!-- 특정 챕터의 학습 시간 조회 (디버깅용) -->
    <select id="selectStudiedSec" resultType="Integer">
        SELECT studied_sec
        FROM study_log
        WHERE user_id = #{userId}
          AND chapter_id = #{chapterId}
        LIMIT 1
    </select>

</mapper>