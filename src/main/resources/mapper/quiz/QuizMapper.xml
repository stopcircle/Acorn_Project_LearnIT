<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learnit.learnit.quiz.repository.QuizMapper">

    <resultMap id="QuizResultMap" type="com.learnit.learnit.quiz.dto.Quiz">
        <id property="quizId" column="quiz_id"/>
        <result property="title" column="title"/>
        <result property="sectionTitle" column="section_title"/>
        <result property="type" column="type"/>
        <collection property="questions" ofType="com.learnit.learnit.quiz.dto.Question">
            <id property="questionId" column="question_id"/>
            <result property="questionContent" column="question_content"/>
            <result property="explanation" column="explanation"/>
            <collection property="options" ofType="com.learnit.learnit.quiz.dto.QuizOption">
                <id property="optionId" column="option_id"/>
                <result property="optionContent" column="option_content"/>
                <result property="isCorrect" column="is_correct"/>
            </collection>
        </collection>
    </resultMap>

    <select id="selectQuizListByCourseId" resultType="com.learnit.learnit.quiz.dto.Quiz">
        SELECT
            quiz_id AS quizId,
            title,
            section_title AS sectionTitle,
            type
        FROM quiz
        WHERE course_id = #{courseId}
    </select>

    <select id="selectFullQuizzesByCourseId" resultMap="QuizResultMap">
        SELECT
            q.quiz_id,
            q.title,
            q.section_title,
            q.type,
            qu.question_id,
            qu.content AS question_content,
            qu.explanation,
            qo.option_id,
            qo.content AS option_content,
            qo.is_correct
        FROM quiz q
                 LEFT JOIN question qu ON q.quiz_id = qu.quiz_id
                 LEFT JOIN quiz_option qo ON qu.question_id = qo.question_id
        WHERE q.course_id = #{courseId}
        ORDER BY q.quiz_id ASC, qu.question_id ASC, qo.option_id ASC
    </select>

    <select id="selectQuizByQuizId" resultMap="QuizResultMap">
        SELECT
            q.quiz_id,
            q.title,
            q.section_title,
            qu.question_id,
            qu.content AS question_content,
            qu.explanation,
            qo.option_id,
            qo.content AS option_content,
            qo.is_correct
        FROM quiz q
                 LEFT JOIN question qu ON q.quiz_id = qu.quiz_id
                 LEFT JOIN quiz_option qo ON qu.question_id = qo.question_id
        WHERE q.quiz_id = #{quizId}
        ORDER BY qu.question_id ASC, qo.option_id ASC
    </select>

    <select id="countUserQuizHistory" resultType="int">
        SELECT COUNT(*)
        FROM user_answer ua
                 JOIN question q ON ua.question_id = q.question_id
        WHERE ua.user_id = #{userId}
          AND q.quiz_id = #{quizId}
    </select>

    <insert id="insertUserAnswer">
        INSERT INTO user_answer (user_id, question_id, sel_option_id, is_correct, answered_at)
        VALUES (#{userId}, #{questionId}, #{optionId}, #{isCorrect}, NOW())
    </insert>

    <insert id="insertQuiz" useGeneratedKeys="true" keyProperty="quiz.quizId">
        INSERT INTO quiz (course_id, section_title, title, type)
        VALUES (#{courseId}, #{quiz.sectionTitle}, #{quiz.title}, #{quiz.type})
    </insert>

    <update id="updateQuiz">
        UPDATE quiz
        SET title = #{title},
            section_title = #{sectionTitle},
            type = #{type}
        WHERE quiz_id = #{quizId}
    </update>

    <delete id="deleteQuiz">
        DELETE FROM quiz WHERE quiz_id = #{quizId}
    </delete>

    <insert id="insertQuestion" useGeneratedKeys="true" keyProperty="question.questionId">
        INSERT INTO question (quiz_id, content, explanation)
        VALUES (#{quizId}, #{question.questionContent}, #{question.explanation})
    </insert>

    <delete id="deleteQuestionsByQuizId">
        DELETE FROM question WHERE quiz_id = #{quizId}
    </delete>

    <insert id="insertOption" useGeneratedKeys="true" keyProperty="option.optionId">
        INSERT INTO quiz_option (question_id, content, is_correct)
        VALUES (#{questionId}, #{option.optionContent}, #{option.isCorrect})
    </insert>

    <delete id="deleteOptionsByQuestionId">
        DELETE FROM quiz_option WHERE question_id = #{questionId}
    </delete>
</mapper>