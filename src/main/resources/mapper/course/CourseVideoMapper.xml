<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learnit.learnit.courseVideo.repository.CourseVideoMapper">
    <select id="findById" resultType="com.learnit.learnit.courseVideo.dto.CourseVideo">
        SELECT
            chapter_id,
            course_id,
            title,
            order_index,
            video_url,
            duration_sec,
            section_title  FROM chapter
        WHERE chapter_id = #{chapterId}
    </select>

    <select id="selectPrevChapterId" resultType="Long">
        SELECT chapter_id
        FROM chapter
        WHERE course_id = #{courseId}
          AND order_index &lt; #{orderIndex}  ORDER BY order_index DESC
            LIMIT 1
    </select>

    <select id="selectNextChapterId" resultType="Long">
        SELECT chapter_id
        FROM chapter
        WHERE course_id = #{courseId}
          AND order_index &gt; #{orderIndex}  ORDER BY order_index ASC
            LIMIT 1
    </select>

    <insert id="insertOrUpdateStudyLog">
        INSERT INTO study_log (
            user_id,
            course_id,
            chapter_id,
            studied_sec,
            created_at
        ) VALUES (
                     #{userId},
                     #{courseId},
                     #{chapterId},
                     #{playTime},
                     NOW()
                 )
            ON DUPLICATE KEY UPDATE
                                 studied_sec = #{playTime},
                                 created_at = NOW()
    </insert>

    <select id="countTotalChapters" resultType="int">
        SELECT COUNT(*) FROM chapter WHERE course_id = #{courseId}
    </select>

    <select id="countCompletedChapters" resultType="int">
        SELECT COUNT(*)
        FROM study_log
        WHERE user_id = #{userId}
          AND course_id = #{courseId}
          AND (studied_sec / (SELECT duration_sec FROM chapter WHERE chapter_id = study_log.chapter_id)) >= 0.95
    </select>

    <update id="updateChapterDuration">
        UPDATE chapter
        SET duration_sec = #{duration}
        WHERE chapter_id = #{chapterId}
          AND (duration_sec IS NULL OR duration_sec = 0)
    </update>

    <select id="selectChapterList" resultType="com.learnit.learnit.courseVideo.dto.CourseVideo">
        SELECT
            c.chapter_id AS chapterId,
            c.course_id AS courseId,
            c.title,
            c.order_index AS orderIndex,
            c.video_url AS videoUrl,
            c.duration_sec AS durationSec,
            c.section_title AS sectionTitle

        FROM chapter c
        WHERE c.course_id = #{courseId}
        ORDER BY c.order_index ASC
    </select>

    <select id="selectCourseResources" resultType="com.learnit.learnit.courseVideo.dto.CourseFile">
        SELECT
            r.resource_id,
            r.chapter_id,
            r.title,
            r.file_url,
            r.file_type
        FROM chapter_resource r
                 JOIN chapter c ON r.chapter_id = c.chapter_id
        WHERE c.course_id = #{courseId}
        ORDER BY c.order_index ASC, r.resource_id ASC
    </select>

    <select id="selectEnrollmentStatus" resultType="String">
        SELECT status
        FROM enrollment
        WHERE user_id = #{userId}
          AND course_id = #{courseId}
    </select>

</mapper>