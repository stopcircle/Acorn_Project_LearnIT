<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learnit.learnit.mypage.mapper.DashboardRepository">

    <!-- 최근 학습 강의 조회 -->
    <select id="selectRecentCourse" resultType="com.learnit.learnit.mypage.dto.CourseSummaryDTO">
        SELECT 
            c.course_id AS courseId,
            c.title,
            c.thumbnail_url AS thumbnailUrl,
            COALESCE(MAX(ch.order_index), 0) AS currentLecture,
            COALESCE((SELECT COUNT(*) FROM chapter WHERE course_id = c.course_id), 0) AS totalLectures,
            CASE 
                WHEN (SELECT COUNT(*) FROM chapter WHERE course_id = c.course_id) > 0 
                THEN ROUND(COALESCE(MAX(ch.order_index), 0) * 100.0 / (SELECT COUNT(*) FROM chapter WHERE course_id = c.course_id), 2)
                ELSE 0
            END AS progressRate,
            e.enrollment_id AS enrollmentId
        FROM enrollment e
        JOIN course c ON e.course_id = c.course_id
        LEFT JOIN study_log sl ON e.user_id = sl.user_id AND e.course_id = sl.course_id
        LEFT JOIN chapter ch ON sl.chapter_id = ch.chapter_id
        WHERE e.user_id = #{userId}
          AND e.status = 'ACTIVE'
        GROUP BY e.enrollment_id, c.course_id, c.title, c.thumbnail_url
        ORDER BY MAX(sl.created_at) DESC, e.created_at DESC
        LIMIT 1
    </select>

    <!-- 주간 학습 데이터 조회 -->
    <select id="selectWeeklyLearning" resultType="com.learnit.learnit.mypage.dto.WeeklyLearningDTO$DailyLearning">
        SELECT 
            CASE DAYOFWEEK(week_days.study_date)
                WHEN 1 THEN '일'
                WHEN 2 THEN '월'
                WHEN 3 THEN '화'
                WHEN 4 THEN '수'
                WHEN 5 THEN '목'
                WHEN 6 THEN '금'
                WHEN 7 THEN '토'
            END AS dayOfWeek,
            DAY(week_days.study_date) AS day,
            COALESCE(COUNT(DISTINCT sl.chapter_id), 0) AS lectureCount,
            COALESCE(SUM(sl.studied_sec) / 60, 0) AS studyMinutes,
            COALESCE(COUNT(DISTINCT wn.note_id), 0) AS noteCount,
            CASE WHEN COUNT(sl.log_id) > 0 THEN 1 ELSE 0 END AS hasStudy
        FROM (
            SELECT DATE(#{startDate}) + INTERVAL seq DAY AS study_date
            FROM (
                SELECT 0 AS seq UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION 
                SELECT 4 UNION SELECT 5 UNION SELECT 6
            ) AS days
        ) AS week_days
        LEFT JOIN study_log sl ON DATE(sl.created_at) = week_days.study_date 
            AND sl.user_id = #{userId}
        LEFT JOIN wrong_note wn ON DATE(wn.created_at) = week_days.study_date 
            AND wn.user_id = #{userId}
        WHERE week_days.study_date BETWEEN DATE(#{startDate}) AND DATE(#{endDate})
        GROUP BY week_days.study_date
        ORDER BY week_days.study_date
    </select>

    <!-- 최근 수료증 조회 -->
    <select id="selectLatestCertificate" resultType="com.learnit.learnit.mypage.dto.CertificateDTO">
        SELECT 
            cert.cert_id AS certificateId,
            c.course_id AS courseId,
            c.title AS courseTitle,
            DATE(cert.issued_at) AS issuedDate,
            CONCAT('/certificates/', cert.certificate_number, '.pdf') AS certificateUrl
        FROM certificate cert
        JOIN enrollment e ON cert.enrollment_id = e.enrollment_id
        JOIN course c ON e.course_id = c.course_id
        WHERE e.user_id = #{userId}
          AND cert.is_approved = 'Y'
        ORDER BY cert.issued_at DESC
        LIMIT 1
    </select>

    <!-- 캘린더 데이터 조회 (월별) -->
    <select id="selectCalendarData" resultType="com.learnit.learnit.mypage.dto.CalendarSummaryDTO$CalendarDay">
        SELECT 
            DAY(sl.created_at) AS day,
            COUNT(DISTINCT sl.chapter_id) AS lectureCount,
            SUM(sl.studied_sec) / 60 AS studyMinutes,
            CASE WHEN COUNT(DISTINCT sl.log_id) > 0 THEN 1 ELSE 0 END AS hasAttendance,
            CASE WHEN COUNT(sl.log_id) > 0 THEN 1 ELSE 0 END AS hasStudy
        FROM study_log sl
        WHERE sl.user_id = #{userId}
          AND YEAR(sl.created_at) = #{year}
          AND MONTH(sl.created_at) = #{month}
        GROUP BY DATE(sl.created_at)
        ORDER BY day
    </select>

    <!-- 특정 날짜의 수강한 강의 목록 조회 -->
    <select id="selectDailyCourses" resultType="com.learnit.learnit.mypage.dto.DailyCourseDTO">
        SELECT 
            c.course_id AS courseId,
            c.title AS courseTitle,
            ch.chapter_id AS chapterId,
            ch.title AS chapterTitle,
            ch.order_index AS chapterOrder,
            TIME(sl.created_at) AS studiedTime,
            SUM(sl.studied_sec) / 60 AS studiedMinutes
        FROM study_log sl
        JOIN course c ON sl.course_id = c.course_id
        LEFT JOIN chapter ch ON sl.chapter_id = ch.chapter_id
        WHERE sl.user_id = #{userId}
          AND YEAR(sl.created_at) = #{year}
          AND MONTH(sl.created_at) = #{month}
          AND DAY(sl.created_at) = #{day}
        GROUP BY c.course_id, c.title, ch.chapter_id, ch.title, ch.order_index, TIME(sl.created_at)
        ORDER BY sl.created_at ASC
    </select>

</mapper>

