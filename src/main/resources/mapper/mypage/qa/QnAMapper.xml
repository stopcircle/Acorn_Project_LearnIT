<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learnit.learnit.mypage.mapper.MyPageQnAMapper">

    <!-- 사용자가 작성한 Q&A 목록 조회 -->
    <select id="selectMyQnAList" resultType="com.learnit.learnit.mypage.dto.QnADTO">
        SELECT 
            q.qna_id AS qnaId,
            q.course_id AS courseId,
            c.title AS courseTitle,
            q.user_id AS userId,
            u.name AS userName,
            q.content,
            q.is_resolved AS isResolved,
            q.created_at AS createdAt,
            a.content AS answer,
            a.created_at AS answeredAt
        FROM qna_question q
        LEFT JOIN course c ON q.course_id = c.course_id AND c.delete_flg = 0
        LEFT JOIN users u ON q.user_id = u.user_id
        LEFT JOIN (
            SELECT a1.qna_id, a1.content, a1.created_at
            FROM qna_answer a1
            INNER JOIN (
                SELECT qna_id, MAX(created_at) AS max_created_at
                FROM qna_answer
                WHERE delete_flg = 0 
                  AND parent_answer_id IS NULL
                GROUP BY qna_id
            ) a2 ON a1.qna_id = a2.qna_id 
                AND a1.created_at = a2.max_created_at
                AND a1.delete_flg = 0
                AND a1.parent_answer_id IS NULL
        ) a ON q.qna_id = a.qna_id
        WHERE q.user_id = #{userId}
          AND q.delete_flg = 0
        ORDER BY q.created_at DESC
    </select>

</mapper>

